import streamlit as st
import pandas as pd
import numpy as np
import os

st.set_page_config(page_title="–ê–Ω–∞–ª–∏–∑ –Ω–∏—à Wildberries", layout="wide")

def format_number(x):
    if pd.isna(x) or x == 0:
        return "‚Äî"
    try:
        return f"{int(x):,}".replace(",", " ")
    except (ValueError, TypeError):
        return "‚Äî"

@st.cache_data(ttl=3600)
def load_data():
    market = pd.read_excel("–ø—Ä–∏–º–µ—Ä.xlsx", sheet_name="–ü—Ä–µ–¥–º–µ—Ç—ã")
    queries = pd.read_excel("–ø—Ä–∏–º–µ—Ä.xlsx", sheet_name="–ó–∞–ø—Ä–æ—Å—ã")
    
    sales_list = []
    for fname in ["–¶–†_–ü—Ä–æ–¥–∞–∂–∏.xlsx", "–ú–°_–ü—Ä–æ–¥–∞–∂–∏.xlsx"]:
        if os.path.exists(fname):
            df = pd.read_excel(fname, sheet_name="–¢–æ–≤–∞—Ä—ã")
            df["–Æ—Ä–ª–∏—Ü–æ"] = fname.split("_")[0]
            sales_list.append(df)
        else:
            st.warning(f"‚ö†Ô∏è –§–∞–π–ª {fname} –Ω–µ –Ω–∞–π–¥–µ–Ω")

    if not sales_list:
        st.error("‚ùå –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–¥–∞–∂")
        st.stop()

    sales = pd.concat(sales_list, ignore_index=True)
    return market, queries, sales

# –ó–ê–ì–†–£–ó–ö–ê
try:
    market, queries, sales = load_data()
except Exception as e:
    st.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
    st.stop()

# –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò –í –ß–ò–°–õ–ê
def convert_to_numeric(df, columns):
    for col in columns:
        if col in df.columns:
            df[col] = pd.to_numeric(df[col], errors='coerce')
    return df

# –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –ö–û–õ–û–ù–û–ö –í –ß–ò–°–õ–ê –ü–ï–†–ï–î –ê–ì–†–ï–ì–ê–¶–ò–ï–ô
numeric_sales_cols = ['–ó–∞–∫–∞–∑–∞–ª–∏ –Ω–∞ —Å—É–º–º—É, ‚ÇΩ', '–í—ã–∫—É–ø–∏–ª–∏ –Ω–∞ —Å—É–º–º—É, ‚ÇΩ']
sales = convert_to_numeric(sales, numeric_sales_cols)

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂ —Å –ö–û–†–†–ï–ö–¢–ù–´–ú –≤—ã–∫—É–ø–æ–º
sales_agg = sales.groupby(['–ü—Ä–µ–¥–º–µ—Ç', '–Æ—Ä–ª–∏—Ü–æ'], as_index=False).agg(
    –ú–æ–∏_–∑–∞–∫–∞–∑—ã=('–ó–∞–∫–∞–∑–∞–ª–∏ –Ω–∞ —Å—É–º–º—É, ‚ÇΩ', 'sum'),
    –ú–æ–∏_–≤—ã–∫—É–ø—ã=('–í—ã–∫—É–ø–∏–ª–∏ –Ω–∞ —Å—É–º–º—É, ‚ÇΩ', 'sum'),
    –ú–æ–∏_—Ç–æ–≤–∞—Ä—ã=('–ê—Ä—Ç–∏–∫—É–ª WB', 'count')
)

# ‚úÖ –ö–û–†–†–ï–ö–¢–ù–´–ô –†–ê–°–ß–Å–¢ –í–´–ö–£–ü–ê
# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ —á–∏—Å–ª–æ–≤–æ–º—É —Ç–∏–ø—É –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º
sales_agg['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] = pd.to_numeric(sales_agg['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'], errors='coerce')
sales_agg['–ú–æ–∏_–≤—ã–∫—É–ø—ã'] = pd.to_numeric(sales_agg['–ú–æ–∏_–≤—ã–∫—É–ø—ã'], errors='coerce')

sales_agg['–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞'] = (
    sales_agg['–ú–æ–∏_–≤—ã–∫—É–ø—ã'] / sales_agg['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'].replace(0, np.nan) * 100
).round(2)

# –ó–∞–ø–æ–ª–Ω—è–µ–º NaN –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ 0
sales_agg['–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞'] = sales_agg['–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞'].fillna(0)

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
queries = convert_to_numeric(queries, ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤'])
queries_agg = queries.groupby('–ü—Ä–µ–¥–º–µ—Ç', as_index=False).agg(
    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤=('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤', 'sum')
)

# –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –†–´–ù–ö–ê
market_numeric_cols = ['–ü—Ä–æ–¥–∞–≤—Ü—ã', '–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏', '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %',
                      '–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '% –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏', '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, ‚ÇΩ',
                      '–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏', '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞']

market = convert_to_numeric(market, market_numeric_cols)

base = market[[
    '–ü—Ä–µ–¥–º–µ—Ç', '–ü—Ä–æ–¥–∞–≤—Ü—ã', '–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏', '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %',
    '–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '% –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏', '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, ‚ÇΩ',
    '–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏', '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞'
]].copy()

base = pd.merge(base, queries_agg, on='–ü—Ä–µ–¥–º–µ—Ç', how='left')
base['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'] = base['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'].fillna(0)

# -------------------------------
# –ù–ê–°–¢–†–û–ô–ö–ò –ò –§–ò–õ–¨–¢–†–´
# -------------------------------
st.sidebar.title("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π")
min_growth = st.sidebar.number_input("–ú–∏–Ω. —Ä–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏ (%)", value=20, step=5)
max_monopoly = st.sidebar.number_input("–ú–∞–∫—Å. –º–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è (%)", value=50, step=5)
min_queries = st.sidebar.number_input("–ú–∏–Ω. –∑–∞–ø—Ä–æ—Å–æ–≤", value=100000, step=10000)
max_turnover = st.sidebar.number_input("–ú–∞–∫—Å. –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å (–¥–Ω–∏)", value=30, step=5)
min_buyout = st.sidebar.number_input("–ú–∏–Ω. –≤—ã–∫—É–ø (%)", value=70, step=5)

legal_entities = ['–õ—é–±–æ–µ'] + sorted(sales_agg['–Æ—Ä–ª–∏—Ü–æ'].dropna().unique())
selected_legal = st.sidebar.selectbox("–Æ—Ä–ª–∏—Ü–æ", legal_entities)

if selected_legal == "–õ—é–±–æ–µ":
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ —á–∏—Å–ª–∞–º –ø–µ—Ä–µ–¥ –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π
    sales_agg['–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞'] = pd.to_numeric(sales_agg['–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞'], errors='coerce')
    
    agg_all = sales_agg.groupby('–ü—Ä–µ–¥–º–µ—Ç', as_index=False).agg(
        –ú–æ–∏_–∑–∞–∫–∞–∑—ã=('–ú–æ–∏_–∑–∞–∫–∞–∑—ã', 'sum'),
        –ú–æ–∏_–≤—ã–∫—É–ø—ã=('–ú–æ–∏_–≤—ã–∫—É–ø—ã', 'sum'),
        –ú–æ–∏_—Ç–æ–≤–∞—Ä—ã=('–ú–æ–∏_—Ç–æ–≤–∞—Ä—ã', 'sum'),
        –ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞=('–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞', 'mean'),
        –Æ—Ä–ª–∏—Ü–∞=('–Æ—Ä–ª–∏—Ü–æ', lambda x: ', '.join(sorted(str(v) for v in x.dropna().unique())))
    )
    result = pd.merge(base, agg_all, on='–ü—Ä–µ–¥–º–µ—Ç', how='left')
    result['–Æ—Ä–ª–∏—Ü–∞'] = result['–Æ—Ä–ª–∏—Ü–∞'].fillna("‚Äî")
else:
    filtered_sales = sales_agg[sales_agg['–Æ—Ä–ª–∏—Ü–æ'] == selected_legal]
    result = pd.merge(base, filtered_sales, on='–ü—Ä–µ–¥–º–µ—Ç', how='left')
    result['–Æ—Ä–ª–∏—Ü–∞'] = selected_legal

# –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
result['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] = result['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'].fillna(0)
result['–ú–æ–∏_–≤—ã–∫—É–ø—ã'] = result['–ú–æ–∏_–≤—ã–∫—É–ø—ã'].fillna(0)
result['–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞'] = result['–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞'].fillna(0)
result['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'] = result['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'].fillna(0)

# –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ —á–∏—Å–ª–æ–≤—ã–º —Ç–∏–ø–∞–º
numeric_cols = ['–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '% –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏', '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %', 
                '–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏', '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞',
                '–ú–æ–∏_–∑–∞–∫–∞–∑—ã', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤', '–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞',
                '–ú–æ–∏_–≤—ã–∫—É–ø—ã']

result = convert_to_numeric(result, numeric_cols)

# –î–æ–ª—è —Ä—ã–Ω–∫–∞
result['–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%'] = (result['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] / result['–í—ã—Ä—É—á–∫–∞, ‚ÇΩ'].replace(0, np.nan) * 100).round(2)
result['–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%'] = result['–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%'].fillna(0)

# -------------------------------
# –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
# -------------------------------
def get_rec(row):
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ NaN
        if pd.isna(row['–ú–æ–∏_–∑–∞–∫–∞–∑—ã']) or pd.isna(row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤']) or pd.isna(row['–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %']):
            return "‚ùì –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö"
            
        if row['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] == 0:
            if (row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'] >= min_queries and
                row['–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %'] <= max_monopoly and
                row.get('% –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏', 0) >= min_growth and
                row.get('–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏', 999) <= max_turnover):
                return "‚úÖ –í—Ö–æ–¥"
            else:
                return "‚è∏ –ù–µ —Å–µ–π—á–∞—Å"
        else:
            if (row.get('–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%', 0) < 5 and
                row.get('% –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏', 0) >= min_growth and
                row.get('–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞', 0) >= min_buyout):
                return "üöÄ –£—Å–∏–ª–µ–Ω–∏–µ"
            elif row.get('–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞', 100) < 70:
                return "‚ö†Ô∏è –í—ã—Ö–æ–¥ / –ê–Ω–∞–ª–∏–∑"
            else:
                return "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"
    except Exception as e:
        return f"‚ùì –û—à–∏–±–∫–∞: {str(e)[:30]}"

result['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'] = result.apply(get_rec, axis=1)

# -------------------------------
# –§–ò–õ–¨–¢–† –ü–û –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
# -------------------------------
rec_options = sorted(result['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'].unique())
selected_recs = st.sidebar.multiselect("–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è", rec_options, default=rec_options)
result = result[result['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'].isin(selected_recs)].copy()

# -------------------------------
# –°–û–†–¢–ò–†–û–í–ö–ê
# -------------------------------
result = result.sort_values('–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', ascending=False).reset_index(drop=True)

# -------------------------------
# –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï
# -------------------------------
st.title("üîç –ê–Ω–∞–ª–∏–∑ –Ω–∏—à Wildberries")

display_df = result.copy()

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–∂–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
money_cols = ['–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, ‚ÇΩ', '–ú–æ–∏_–∑–∞–∫–∞–∑—ã', '–ú–æ–∏_–≤—ã–∫—É–ø—ã']
for col in money_cols:
    if col in display_df.columns:
        display_df[col] = display_df[col].apply(format_number)

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
count_cols = ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤', '–ü—Ä–æ–¥–∞–≤—Ü—ã', '–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏', '–ú–æ–∏_—Ç–æ–≤–∞—Ä—ã']
for col in count_cols:
    if col in display_df.columns:
        display_df[col] = display_df[col].apply(lambda x: format_number(x) if pd.notna(x) else "‚Äî")

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
percent_cols = ['–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %', '–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%', '–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞', 
                '% –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏', '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞']
for col in percent_cols:
    if col in display_df.columns:
        display_df[col] = display_df[col].apply(lambda x: f"{x:.1f}%" if pd.notna(x) and not pd.isnull(x) else "‚Äî")

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω–µ–π
day_cols = ['–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏']
for col in day_cols:
    if col in display_df.columns:
        display_df[col] = display_df[col].apply(lambda x: f"{x:.0f}" if pd.notna(x) else "‚Äî")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
display_columns = ['–ü—Ä–µ–¥–º–µ—Ç', '–Æ—Ä–ª–∏—Ü–∞', '–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤', 
                   '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %', '–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏', '–ú–æ–∏_–∑–∞–∫–∞–∑—ã', 
                   '–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%', '–ú–æ–π_–ø—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è']

# –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
existing_columns = [col for col in display_columns if col in display_df.columns]

st.dataframe(
    display_df[existing_columns],
    use_container_width=True,
    hide_index=True
)

# -------------------------------
# –ó–ê–ü–†–û–°–´ –ü–û –ü–†–ï–î–ú–ï–¢–£
# -------------------------------
st.subheader("üîé –ó–∞–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É")
if '–ü—Ä–µ–¥–º–µ—Ç' in result.columns and not result['–ü—Ä–µ–¥–º–µ—Ç'].empty:
    subjects = sorted(result['–ü—Ä–µ–¥–º–µ—Ç'].dropna().unique())
    selected_subject = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç", subjects)

    if selected_subject:
        q = queries[queries['–ü—Ä–µ–¥–º–µ—Ç'] == selected_subject].copy()
        
        if not q.empty:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ —á–∏—Å–ª–∞
            query_numeric_cols = ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)',
                                '–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤', '–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)']
            q = convert_to_numeric(q, query_numeric_cols)
            
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            q['Œî –ó–∞–ø—Ä–æ—Å—ã, %'] = (
                (q['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤'] - q['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)']) /
                q['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)'].replace(0, np.nan) * 100
            ).round(1)
            
            q['Œî –ó–∞–∫–∞–∑—ã, %'] = (
                (q['–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤'] - q['–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)']) /
                q['–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)'].replace(0, np.nan) * 100
            ).round(1)
            
            q = q.sort_values('–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤', ascending=False)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            display_cols = ['–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤', 
                          '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)', 'Œî –ó–∞–ø—Ä–æ—Å—ã, %',
                          '–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤', '–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)', 'Œî –ó–∞–∫–∞–∑—ã, %']
            
            display_q = q[display_cols].copy()
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
            for col in ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)',
                       '–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤', '–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥)']:
                display_q[col] = display_q[col].apply(format_number)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
            for col in ['Œî –ó–∞–ø—Ä–æ—Å—ã, %', 'Œî –ó–∞–∫–∞–∑—ã, %']:
                display_q[col] = display_q[col].apply(lambda x: f"{x:.1f}%" if pd.notna(x) else "‚Äî")
            
            st.dataframe(
                display_q,
                use_container_width=True,
                hide_index=True
            )
        else:
            st.info("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞")
else:
    st.info("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–µ–¥–º–µ—Ç–∞—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")

# -------------------------------
# –°–¢–ê–¢–ò–°–¢–ò–ö–ê
# -------------------------------
st.sidebar.subheader("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
if not result.empty:
    total_categories = len(result)
    enter_categories = len(result[result['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'] == "‚úÖ –í—Ö–æ–¥"])
    st.sidebar.metric("–í—Å–µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π", total_categories)
    st.sidebar.metric("–î–ª—è –≤—Ö–æ–¥–∞", enter_categories)
import streamlit as st
import pandas as pd
import os

st.set_page_config(page_title="–ê–Ω–∞–ª–∏–∑ –Ω–∏—à Wildberries", layout="wide")

def format_number(x):
    if pd.isna(x) or x == 0:
        return "‚Äî"
    return f"{int(x):,}".replace(",", " ")

@st.cache_data(ttl=3600)
def load_data():
    # –ó–∞–≥—Ä—É–∑–∫–∞ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    market = pd.read_excel("–ø—Ä–∏–º–µ—Ä.xlsx", sheet_name="–ü—Ä–µ–¥–º–µ—Ç—ã")
    queries = pd.read_excel("–ø—Ä–∏–º–µ—Ä.xlsx", sheet_name="–ó–∞–ø—Ä–æ—Å—ã")
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ —é—Ä–ª–∏—Ü–∞–º
    sales_list = []
    for fname in ["–¶–†_–ü—Ä–æ–¥–∞–∂–∏.xlsx", "–ú–°_–ü—Ä–æ–¥–∞–∂–∏.xlsx"]:
        if os.path.exists(fname):
            df = pd.read_excel(fname, sheet_name="–¢–æ–≤–∞—Ä—ã")
            df["–Æ—Ä–ª–∏—Ü–æ"] = fname.split("_")[0]
            sales_list.append(df)
        else:
            st.warning(f"‚ö†Ô∏è –§–∞–π–ª {fname} –Ω–µ –Ω–∞–π–¥–µ–Ω")
    if not sales_list:
        st.error("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º")
        st.stop()
    sales = pd.concat(sales_list, ignore_index=True)
    return market, queries, sales

market, queries, sales = load_data()

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂
sales_agg = sales.groupby(['–ü—Ä–µ–¥–º–µ—Ç', '–Æ—Ä–ª–∏—Ü–æ'], as_index=False).agg(
    –ú–æ–∏_–∑–∞–∫–∞–∑—ã=('–ó–∞–∫–∞–∑–∞–ª–∏ –Ω–∞ —Å—É–º–º—É, ‚ÇΩ', 'sum'),
    –ú–æ–∏_—Ç–æ–≤–∞—Ä—ã=('–ê—Ä—Ç–∏–∫—É–ª WB', 'count'),
    –ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç=('–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞', 'mean')
)

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
queries_agg = queries.groupby('–ü—Ä–µ–¥–º–µ—Ç', as_index=False).agg(
    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤=('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤', 'sum')
)

# –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ä—ã–Ω–æ—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
base = market[[
    '–ü—Ä–µ–¥–º–µ—Ç', '–ü—Ä–æ–¥–∞–≤—Ü—ã', '–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏', '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %',
    '–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '%  –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏', '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, ‚ÇΩ',
    '–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏', '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞'
]].copy()

# –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å—ã –∏ –ø—Ä–æ–¥–∞–∂–∏
base = pd.merge(base, queries_agg, on='–ü—Ä–µ–¥–º–µ—Ç', how='left')
base = pd.merge(base, sales_agg, on='–ü—Ä–µ–¥–º–µ—Ç', how='left')

# –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–ø—É—Å–∫–∏
base['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'] = base['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'].fillna(0)
base['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] = base['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'].fillna(0)
base['–ú–æ–∏_—Ç–æ–≤–∞—Ä—ã'] = base['–ú–æ–∏_—Ç–æ–≤–∞—Ä—ã'].fillna(0)
base['–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç'] = base['–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç'].fillna(0)

# –î–æ–ª—è —Ä—ã–Ω–∫–∞
base['–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%'] = (base['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] / base['–í—ã—Ä—É—á–∫–∞, ‚ÇΩ'].replace(0, 1) * 100).round(2)

# -------------------------------
# –ù–ê–°–¢–†–û–ô–ö–ò –ò –§–ò–õ–¨–¢–†–´
# -------------------------------
st.sidebar.title("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π")
min_growth = st.sidebar.number_input("–ú–∏–Ω. —Ä–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏ (%)", value=20, step=5)
max_monopoly = st.sidebar.number_input("–ú–∞–∫—Å. –º–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è (%)", value=50, step=5)
min_queries = st.sidebar.number_input("–ú–∏–Ω. –∑–∞–ø—Ä–æ—Å–æ–≤", value=100000, step=10000)
max_turnover = st.sidebar.number_input("–ú–∞–∫—Å. –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å (–¥–Ω–∏)", value=30, step=5)
min_buyout = st.sidebar.number_input("–ú–∏–Ω. –≤—ã–∫—É–ø (%)", value=70, step=5)

legal_entities = ['–õ—é–±–æ–µ'] + sorted(base['–Æ—Ä–ª–∏—Ü–æ'].dropna().unique())
selected_legal = st.sidebar.selectbox("–Æ—Ä–ª–∏—Ü–æ", legal_entities)

if selected_legal == '–õ—é–±–æ–µ':
    agg = base.groupby('–ü—Ä–µ–¥–º–µ—Ç', as_index=False).agg(
        –í—ã—Ä—É—á–∫–∞_‚ÇΩ=('–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', 'first'),
        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤=('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤', 'first'),
        –ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è=('–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %', 'first'),
        –ü—Ä–æ–¥–∞–≤—Ü—ã=('–ü—Ä–æ–¥–∞–≤—Ü—ã', 'first'),
        –ü—Ä–æ–¥–∞–≤—Ü—ã_—Å_–∑–∞–∫–∞–∑–∞–º–∏=('–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏', 'first'),
        –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å=('–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏', 'first'),
        –ü—Ä–æ—Ü–µ–Ω—Ç_–≤—ã–∫—É–ø–∞=('–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞', 'first'),
        –ú–æ–∏_–∑–∞–∫–∞–∑—ã=('–ú–æ–∏_–∑–∞–∫–∞–∑—ã', 'sum'),
        –Æ—Ä–ª–∏—Ü–∞=('–Æ—Ä–ª–∏—Ü–æ', lambda x: ', '.join(sorted(x.dropna().unique()))),
        –ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞=('–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%', 'mean'),
        –ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç=('–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç', 'mean')
    )
    df = agg
else:
    df = base[base['–Æ—Ä–ª–∏—Ü–æ'] == selected_legal].copy()
    df['–Æ—Ä–ª–∏—Ü–∞'] = selected_legal

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–±–µ–∑ KeyError!)
def get_rec(row):
    if row['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] == 0:
        if (row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'] >= min_queries and
            row['–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è'] <= max_monopoly and
            row['%  –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏'] >= min_growth and
            row['–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å'] <= max_turnover):
            return "‚úÖ –í—Ö–æ–¥"
        else:
            return "‚è∏ –ù–µ —Å–µ–π—á–∞—Å"
    else:
        if (row['–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞'] < 5 and
            row['%  –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏'] >= min_growth and
            row['–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç'] >= min_buyout):
            return "üöÄ –£—Å–∏–ª–µ–Ω–∏–µ"
        elif row['–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç'] < 70:
            return "‚ö†Ô∏è –í—ã—Ö–æ–¥ / –ê–Ω–∞–ª–∏–∑"
        else:
            return "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"

df['%  –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏'] = df['%  –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏'].fillna(0)
df['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'] = df.apply(get_rec, axis=1)

# –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
recs = st.sidebar.multiselect(
    "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è",
    options=sorted(df['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'].unique()),
    default=sorted(df['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'].unique())
)
df = df[df['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'].isin(recs)].copy()

# ‚úÖ –°–û–†–¢–ò–†–û–í–ö–ê –ü–û –ß–ò–°–õ–û–í–´–ú –ö–û–õ–û–ù–ö–ê–ú (–¥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!)
df = df.sort_values('–í—ã—Ä—É—á–∫–∞, ‚ÇΩ' if '–í—ã—Ä—É—á–∫–∞, ‚ÇΩ' in df.columns else '–í—ã—Ä—É—á–∫–∞_‚ÇΩ', ascending=False)

# -------------------------------
# –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï
# -------------------------------
st.title("üîç –ê–Ω–∞–ª–∏–∑ –Ω–∏—à Wildberries")

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
display = df.copy()
display['–í—ã—Ä—É—á–∫–∞, ‚ÇΩ'] = display.get('–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', display.get('–í—ã—Ä—É—á–∫–∞_‚ÇΩ', 0)).apply(format_number)
display['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'] = display['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'].apply(format_number)
display['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] = display['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'].apply(format_number)

st.dataframe(
    display[[
        '–ü—Ä–µ–¥–º–µ—Ç', '–Æ—Ä–ª–∏—Ü–∞', '–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤', '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è',
        '–ü—Ä–æ–¥–∞–≤—Ü—ã_—Å_–∑–∞–∫–∞–∑–∞–º–∏', '–ú–æ–∏_–∑–∞–∫–∞–∑—ã', '–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞', '–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'
    ]].rename(columns={
        '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è': '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %',
        '–ü—Ä–æ–¥–∞–≤—Ü—ã_—Å_–∑–∞–∫–∞–∑–∞–º–∏': '–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏',
        '–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞': '–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%'
    }),
    use_container_width=True,
    hide_index=True
)

# –ó–∞–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É
st.subheader("üîé –ó–∞–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É")
subjects = sorted(df['–ü—Ä–µ–¥–º–µ—Ç'].dropna().unique())
selected_subject = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç", subjects)

if selected_subject:
    q = queries[queries['–ü—Ä–µ–¥–º–µ—Ç'] == selected_subject].copy()
    q = q.sort_values('–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤', ascending=False)
    st.dataframe(
        q[['–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤', '–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤']],
        use_container_width=True
    )
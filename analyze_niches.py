import streamlit as st
import pandas as pd
import os

# -------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–≤–æ–π)
# -------------------------------
st.set_page_config(
    page_title="–ê–Ω–∞–ª–∏–∑ –Ω–∏—à Wildberries",
    layout="wide"
)

# -------------------------------
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# -------------------------------
def format_number(x):
    if pd.isna(x) or x == 0:
        return "‚Äî"
    return f"{int(x):,}".replace(",", " ")

def safe_join(x):
    """–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è, –∏–≥–Ω–æ—Ä–∏—Ä—É—è NaN"""
    valid = x.dropna().astype(str).unique()
    return ', '.join(sorted(valid)) if len(valid) > 0 else "‚Äî"

# -------------------------------
# –ó–ê–ì–†–£–ó–ö–ê –ò –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–•
# -------------------------------
@st.cache_data(ttl=3600)
def prepare_data():
    # –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    market = pd.read_excel("–ø—Ä–∏–º–µ—Ä.xlsx", sheet_name="–ü—Ä–µ–¥–º–µ—Ç—ã")
    queries = pd.read_excel("–ø—Ä–∏–º–µ—Ä.xlsx", sheet_name="–ó–∞–ø—Ä–æ—Å—ã")
    
    # –ü—Ä–æ–¥–∞–∂–∏ –ø–æ —é—Ä–ª–∏—Ü–∞–º
    files = ["–¶–†_–ü—Ä–æ–¥–∞–∂–∏.xlsx", "–ú–°_–ü—Ä–æ–¥–∞–∂–∏.xlsx"]
    sales_list = []
    for file in files:
        if os.path.exists(file):
            df = pd.read_excel(file, sheet_name="–¢–æ–≤–∞—Ä—ã")
            df["–Æ—Ä–ª–∏—Ü–æ"] = file.split("_")[0]
            sales_list.append(df)
        else:
            st.warning(f"‚ö†Ô∏è –§–∞–π–ª {file} –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    if not sales_list:
        st.error("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º")
        st.stop()
    
    sales = pd.concat(sales_list, ignore_index=True)

    # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂ –ø–æ (–ü—Ä–µ–¥–º–µ—Ç, –Æ—Ä–ª–∏—Ü–æ)
    sales_agg = sales.groupby(['–ü—Ä–µ–¥–º–µ—Ç', '–Æ—Ä–ª–∏—Ü–æ']).agg(
        –ú–æ–∏_–∑–∞–∫–∞–∑—ã=('–ó–∞–∫–∞–∑–∞–ª–∏ –Ω–∞ —Å—É–º–º—É, ‚ÇΩ', 'sum'),
        –ú–æ–∏_–≤—ã–∫—É–ø—ã=('–í—ã–∫—É–ø–∏–ª–∏ –Ω–∞ —Å—É–º–º—É, ‚ÇΩ', 'sum'),
        –ú–æ–∏_—Ç–æ–≤–∞—Ä—ã=('–ê—Ä—Ç–∏–∫—É–ª WB', 'count')
    ).round(2).reset_index()

    # –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç –≤—ã–∫—É–ø–∞: —Ç–æ–ª—å–∫–æ –≥–¥–µ –µ—Å—Ç—å –∑–∞–∫–∞–∑—ã
    sales_agg['–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç'] = 0.0
    mask = sales_agg['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] > 0
    sales_agg.loc[mask, '–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç'] = (
        sales_agg.loc[mask, '–ú–æ–∏_–≤—ã–∫—É–ø—ã'] / sales_agg.loc[mask, '–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] * 100
    ).round(2)

    # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
    queries_agg = queries.groupby('–ü—Ä–µ–¥–º–µ—Ç')['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤'].sum().reset_index()
    queries_agg.rename(columns={'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'}, inplace=True)

    # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
    base = market[[
        '–ü—Ä–µ–¥–º–µ—Ç', '–ü—Ä–æ–¥–∞–≤—Ü—ã', '–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏', '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %',
        '–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '%  –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏', '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, ‚ÇΩ',
        '–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏', '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞'
    ]].merge(queries_agg, on='–ü—Ä–µ–¥–º–µ—Ç', how='left')
    base['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'] = base['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'].fillna(0)

    return base, sales_agg, queries

# -------------------------------
# –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
# -------------------------------
base, sales_agg, queries = prepare_data()

# -------------------------------
# –ù–ê–°–¢–†–û–ô–ö–ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô
# -------------------------------
st.sidebar.title("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π")
min_growth = st.sidebar.number_input("–ú–∏–Ω. —Ä–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏ (%)", value=20, step=5)
max_monopoly = st.sidebar.number_input("–ú–∞–∫—Å. –º–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è (%)", value=50, step=5)
min_queries = st.sidebar.number_input("–ú–∏–Ω. –∑–∞–ø—Ä–æ—Å–æ–≤", value=100000, step=10000)
max_turnover = st.sidebar.number_input("–ú–∞–∫—Å. –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å (–¥–Ω–∏)", value=30, step=5)
min_buyout = st.sidebar.number_input("–ú–∏–Ω. –≤—ã–∫—É–ø (%)", value=70, step=5)

# -------------------------------
# –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –Æ–†–õ–ò–¶–£
# -------------------------------
legal_entities = sorted(sales_agg["–Æ—Ä–ª–∏—Ü–æ"].dropna().unique())
selected_legal = st.sidebar.selectbox("–Æ—Ä–ª–∏—Ü–æ", ["–õ—é–±–æ–µ"] + legal_entities)

# -------------------------------
# –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –ë–ï–ó –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø
# -------------------------------
if selected_legal == "–õ—é–±–æ–µ":
    # –ê–≥—Ä–µ–≥–∞—Ü–∏—è: —Å—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤, —Å–ø–∏—Å–æ–∫ —é—Ä–ª–∏—Ü
    combined = sales_agg.groupby('–ü—Ä–µ–¥–º–µ—Ç').agg(
        –ú–æ–∏_–∑–∞–∫–∞–∑—ã=('–ú–æ–∏_–∑–∞–∫–∞–∑—ã', 'sum'),
        –ú–æ–∏_–≤—ã–∫—É–ø—ã=('–ú–æ–∏_–≤—ã–∫—É–ø—ã', 'sum'),
        –ú–æ–∏_—Ç–æ–≤–∞—Ä—ã=('–ú–æ–∏_—Ç–æ–≤–∞—Ä—ã', 'sum'),
        –Æ—Ä–ª–∏—Ü–∞=('–Æ—Ä–ª–∏—Ü–æ', safe_join),
        –ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç=('–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç', 'mean')
    ).round(2).reset_index()
    result = base.merge(combined, on='–ü—Ä–µ–¥–º–µ—Ç', how='left')
    result['–Æ—Ä–ª–∏—Ü–∞'] = result['–Æ—Ä–ª–∏—Ü–∞'].fillna("‚Äî")
else:
    filtered = sales_agg[sales_agg['–Æ—Ä–ª–∏—Ü–æ'] == selected_legal]
    result = base.merge(filtered, on='–ü—Ä–µ–¥–º–µ—Ç', how='left')
    result['–Æ—Ä–ª–∏—Ü–∞'] = selected_legal

# –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–ø—É—Å–∫–∏
for col in ['–ú–æ–∏_–∑–∞–∫–∞–∑—ã', '–ú–æ–∏_–≤—ã–∫—É–ø—ã', '–ú–æ–∏_—Ç–æ–≤–∞—Ä—ã', '–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç']:
    result[col] = result[col].fillna(0)

# –†–∞—Å—á—ë—Ç –¥–æ–ª–∏ —Ä—ã–Ω–∫–∞
result['–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%'] = (result['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] / result['–í—ã—Ä—É—á–∫–∞, ‚ÇΩ'].replace(0, 1) * 100).round(2)

# -------------------------------
# –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
# -------------------------------
def get_rec(row):
    if row['–ú–æ–∏_–∑–∞–∫–∞–∑—ã'] == 0:
        if (row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤'] >= min_queries and
            row['–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %'] <= max_monopoly and
            row['%  –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏'] >= min_growth and
            row['–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é, –¥–Ω–∏'] <= max_turnover):
            return "‚úÖ –í—Ö–æ–¥"
        else:
            return "‚è∏ –ù–µ —Å–µ–π—á–∞—Å"
    else:
        if (row['–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%'] < 5 and
            row['%  –ø—Ä–∏—Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏'] >= min_growth and
            row['–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç'] > 80):
            return "üöÄ –£—Å–∏–ª–µ–Ω–∏–µ"
        elif row['–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç'] < 70:
            return "‚ö†Ô∏è –í—ã—Ö–æ–¥ / –ê–Ω–∞–ª–∏–∑"
        else:
            return "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"

result['–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'] = result.apply(get_rec, axis=1)

# -------------------------------
# –°–û–†–¢–ò–†–û–í–ö–ê –ü–û –í–´–†–£–ß–ö–ï (—á–∏—Å–ª–æ–≤–∞—è!)
# -------------------------------
result = result.sort_values('–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', ascending=False).reset_index(drop=True)

# -------------------------------
# –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï
# -------------------------------
st.title("üîç –ê–Ω–∞–ª–∏–∑ –Ω–∏—à Wildberries")

# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
df_display = result.copy()
for col in ['–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤', '–ú–æ–∏_–∑–∞–∫–∞–∑—ã']:
    df_display[col] = df_display[col].apply(format_number)

st.dataframe(
    df_display[[
        '–ü—Ä–µ–¥–º–µ—Ç', '–Æ—Ä–ª–∏—Ü–∞', '–í—ã—Ä—É—á–∫–∞, ‚ÇΩ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø—Ä–æ—Å–æ–≤', '–ú–æ–Ω–æ–ø–æ–ª–∏–∑–∞—Ü–∏—è, %',
        '–ü—Ä–æ–¥–∞–≤—Ü—ã —Å –∑–∞–∫–∞–∑–∞–º–∏', '–ú–æ–∏_–∑–∞–∫–∞–∑—ã', '–ú–æ—è_–¥–æ–ª—è_—Ä—ã–Ω–∫–∞_%', '–ú–æ–π_–≤—ã–∫—É–ø_–ø—Ä–æ—Ü–µ–Ω—Ç', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'
    ]],
    use_container_width=True,
    height=700,
    hide_index=True  # ‚Üê —Å–∫—Ä—ã–≤–∞–µ—Ç –Ω—É–º–µ—Ä–∞—Ü–∏—é —Å—Ç—Ä–æ–∫
)

# -------------------------------
# –ó–ê–ü–†–û–°–´ –ü–û –ü–†–ï–î–ú–ï–¢–£
# -------------------------------
st.subheader("üîé –ó–∞–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É")
subjects = sorted(result['–ü—Ä–µ–¥–º–µ—Ç'].unique())
selected_subject = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç", subjects)

if selected_subject:
    q_filtered = queries[queries['–ü—Ä–µ–¥–º–µ—Ç'] == selected_subject].copy()
    q_filtered = q_filtered.sort_values('–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤', ascending=False)
    st.dataframe(
        q_filtered[['–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤', '–ó–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤', '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –∑–∞–∫–∞–∑']],
        use_container_width=True,
        height=600
    )